{"content":"{\"cells\":[{\"type\":\"devs.PMStartPoint\",\"size\":{\"width\":40,\"height\":39},\"outPorts\":[\" \"],\"inPorts\":[],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\" \"}}}]},\"position\":{\"x\":57,\"y\":-287},\"angle\":0,\"id\":\"54f9712e-2e9d-4a21-9cf7-fbf6b763c906\",\"z\":1,\"attrs\":{\"rect\":{\"fill\":\"#2d3236\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":-246,\"y\":-498.5},\"angle\":0,\"id\":\"5f03bb41-a6c0-4d00-aa25-caa1f31ef307\",\"z\":2,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill-opacity\":0.5,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"CommandLine\"},\".p_id\":{\"text\":\"620666f67a973c003208da9e\"},\"image\":{\"xlink:href\":\"/plugins/CommandLine/CommandLine.png\",\"ref-y\":50}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":258,\"y\":-302},\"angle\":0,\"id\":\"a7f2bf0e-2218-452c-b93e-e531b9a5f441\",\"z\":6,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\",\"fill-opacity\":0.5},\".label\":{\"text\":\"describeInstances\"},\".p_id\":{\"text\":\"620666f67a973c003208da9e\"},\"image\":{\"xlink:href\":\"/plugins/CommandLine/CommandLine.png\",\"ref-y\":50},\"text\":{\"text\":\"describeInstances\"}}},{\"type\":\"link\",\"source\":{\"id\":\"54f9712e-2e9d-4a21-9cf7-fbf6b763c906\",\"port\":\" \"},\"target\":{\"id\":\"a7f2bf0e-2218-452c-b93e-e531b9a5f441\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"2a2999cb-a5ae-48b4-aa3a-6d967c97dec9\",\"z\":7,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":491,\"y\":-303},\"angle\":0,\"id\":\"c3242ff8-f9de-4216-b023-68809470436c\",\"z\":12,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill-opacity\":0.5,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"return-ids\"},\".p_id\":{\"text\":\"620666f67a973c003208da9e\"},\"image\":{\"xlink:href\":\"/plugins/CommandLine/CommandLine.png\",\"ref-y\":50},\"text\":{\"text\":\"return-ids\"}}},{\"type\":\"link\",\"source\":{\"id\":\"a7f2bf0e-2218-452c-b93e-e531b9a5f441\",\"port\":\"  \"},\"target\":{\"id\":\"c3242ff8-f9de-4216-b023-68809470436c\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"a7989f97-d46d-4304-937f-921932144231\",\"z\":13,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}}]}","code":"/*\r\ngetInstanceIdsWithoutTag() function parses all instances returned by the describeInstances action\r\nand if instance does not have a tag with key equal to \"tagKey\" from \"Configurations\" - instance is considered as non compliant with the tag rule and will be returned in a list.\r\n\r\nNOTE: This script does not check Tag Value, but it can easily be added as another check after `if (tagKeyValue.Key == requiredTagKey)` \r\nsomething like another `if (tagKeyValue.Value == requiredTagValue)`.\r\n\r\nAlso, this script assumes that all instances are within the same \"Reservations\" block (AWS CLI output), so in a potential plugin method it should iterate over every reservation as well.\r\n*/\r\n\r\n// Getting tag key name from Configurations\r\nlet requiredTagKey = kaholo.pipeline.configurations[0].value.tagKey\r\nlet awsAccessKeyID = kaholo.pipeline.configurations[0].value.awsAccessKeyID\r\nlet awsSecretAccessKey = kaholo.pipeline.configurations[0].value.awsSecretAccessKey\r\nlet awsRegion = kaholo.pipeline.configurations[0].value.awsRegion\r\n\r\nfunction getInstanceIdsWithoutTag(){\r\n    let output = JSON.parse(actions.describeInstances.result)\r\n    let instances = output.Reservations[0].Instances\r\n    let instanceIDs = []\r\n\r\n    for (let key in instances) {\r\n        let satisfiesTagRequirement = false\r\n        let instance = instances[key]\r\n        if (instance.hasOwnProperty('Tags')) {\r\n            tags = instance.Tags\r\n            for (let tagKey in tags) {\r\n                let tagKeyValue = tags[tagKey]\r\n                if (tagKeyValue.Key == requiredTagKey) {\r\n                    // Instance has the requiredTagKey and won't be added to the instanceIDs\r\n                    satisfiesTagRequirement = true\r\n                }\r\n            }\r\n        }\r\n        // If instance does not have requiredTagKey in tags it will be added to the instanceIDs\r\n        if (!satisfiesTagRequirement) {\r\n            instanceIDs.push(instance.InstanceId)\r\n        }\r\n    }\r\n\r\n    return `echo ${JSON.stringify(instanceIDs)}`\r\n}\r\n","plugins":[],"processes":[{"id":"620668407a973c003208e6c4","uuid":"5f03bb41-a6c0-4d00-aa25-caa1f31ef307","codeId":"commandline1","name":"","description":"","mandatory":true,"coordination":"","condition":"","preRun":"","postRun":"","filterAgents":"","actionsExecution":"series","actions":[{"retries":null,"timeout":null,"name":"","mandatory":true,"method":"","params":[],"isEnabled":true,"numParallel":""}],"used_plugin":{"name":"CommandLine","version":"3.0.2"},"correlateAgents":false,"numProcessParallel":""},{"id":"620668407a973c003208e6c6","uuid":"a7f2bf0e-2218-452c-b93e-e531b9a5f441","codeId":"describeInstances","name":"","description":"","mandatory":true,"coordination":"","condition":"","preRun":"","postRun":"","filterAgents":"","actionsExecution":"series","actions":[{"retries":null,"timeout":null,"name":"","mandatory":true,"method":"executeCommands","params":[{"value":"`aws configure set aws_access_key_id ${awsAccessKeyID}`; `aws configure set aws_secret_access_key ${awsSecretAccessKey}`; `aws configure set default.region ${awsRegion}`; `aws ec2 describe-instances`","code":true,"id":"620666f67a973c003208daa8","_id":"620666f67a973c003208daa8","language":null,"viewName":"Commands","name":"COMMANDS","required":false,"param":"620666f67a973c003208daa8","type":"text"}],"isEnabled":true,"numParallel":""}],"used_plugin":{"name":"CommandLine","version":"3.0.2"},"correlateAgents":null,"numProcessParallel":""},{"id":"620668407a973c003208e6d4","uuid":"c3242ff8-f9de-4216-b023-68809470436c","codeId":"return-ids","name":"","description":"","mandatory":true,"coordination":"","condition":"","preRun":"","postRun":"","filterAgents":"","actionsExecution":"series","actions":[{"retries":null,"timeout":null,"name":"","mandatory":true,"method":"execute","params":[{"value":null,"code":null,"id":"61fcf2ac36420d00329ab312","_id":"61fcf2ac36420d00329ab312","language":null,"viewName":"Working Directory","name":"workingDir","required":false,"param":"620666f67a973c003208daa0","type":"string"},{"value":"getInstanceIdsWithoutTag()","code":true,"id":"61fcf2ac36420d00329ab313","_id":"61fcf2ac36420d00329ab313","language":null,"viewName":"Command","name":"COMMANDS","required":false,"param":"620666f67a973c003208daa1","type":"string"},{"value":null,"code":null,"id":"61fcf2ac36420d00329ab314","_id":"61fcf2ac36420d00329ab314","language":null,"viewName":"Wait For Close","name":"exitOnClose","required":false,"param":"620666f67a973c003208daa2","type":"boolean"},{"value":null,"code":null,"id":"61fcf2ac36420d00329ab315","_id":"61fcf2ac36420d00329ab315","language":null,"viewName":"Shell Type","name":"shell","required":false,"param":"620666f67a973c003208daa3","type":"options"}],"isEnabled":true,"numParallel":""}],"used_plugin":{"name":"CommandLine","version":"3.0.2"},"correlateAgents":null,"numProcessParallel":""}],"configurations":[{"name":"parameters","value":"{\n    \"tagKey\": \"kaholo\",\n    \"awsAccessKeyID\": \"\",\n    \"awsSecretAccessKey\": \"\",\n    \"awsRegion\": \"\"\n}","_id":"620668407a973c003208e6dd"}],"links":[{"uuid":"2a2999cb-a5ae-48b4-aa3a-6d967c97dec9","sourceId":"54f9712e-2e9d-4a21-9cf7-fbf6b763c906","targetId":"a7f2bf0e-2218-452c-b93e-e531b9a5f441"},{"uuid":"a7989f97-d46d-4304-937f-921932144231","sourceId":"a7f2bf0e-2218-452c-b93e-e531b9a5f441","targetId":"c3242ff8-f9de-4216-b023-68809470436c"}],"used_plugins":[{"name":"CommandLine","version":"3.0.2"},{"name":"CommandLine","version":"3.0.2"},{"name":"CSV","version":"1.0.2"},{"name":"CommandLine","version":"3.0.2"},{"name":"CommandLine","version":"3.0.2"}],"exportedPipeline":{"description":"","queue":null}}